<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Assinador V16 - H√≠brido</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        /* --- CSS IGUAL AO ANTERIOR (Mantendo o Dark Mode Pro) --- */
        * { box-sizing: border-box; touch-action: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; background-color: #121212; color: #eee;
            display: flex; flex-direction: column; height: 100dvh; overflow: hidden;
        }

        /* HEADER */
        header {
            background: #1e1e1e; padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px; border-bottom: 1px solid #333; z-index: 20;
        }

        .title { font-weight: 700; font-size: 16px; color: #fff; }
        .tools { display: flex; gap: 12px; }
        .btn-icon {
            background: #2c2c2c; border: 1px solid #444; color: #eee;
            width: 42px; height: 40px; border-radius: 8px;
            font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .btn-icon:hover { background: #444; }

        /* WORKSPACE */
        #workspace {
            flex-grow: 1; position: relative; background: #000;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            padding-bottom: 90px; cursor: crosshair;
        }

        #mainCanvas {
            max-width: 98%; max-height: 98%;
            box-shadow: 0 0 20px rgba(0,0,0,0.8); display: none; 
        }

        /* START SCREEN */
        #startScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #121212; z-index: 5;
        }
        
        .btn-big-open {
            background: #2a2a2a; border: 2px dashed #555; color: #ddd;
            width: 85%; padding: 40px 20px; border-radius: 16px;
            text-align: center; margin-top: -60px; transition: background 0.2s; cursor: pointer;
        }
        .btn-big-open:hover { background: #333; }
        .btn-big-open span { font-size: 45px; display: block; margin-bottom: 15px; }
        .btn-big-open h3 { margin: 0; font-size: 20px; color: #fff; font-weight: 600; }
        
        #instruction {
            position: absolute; top: 15px;
            background: rgba(255, 193, 7, 0.95); color: #000;
            padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 13px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); pointer-events: none;
            display: none; z-index: 10;
        }
        
        #loading { display: none; color: #aaa; font-size: 14px; margin-top: 20px; }

        /* ACTION BAR */
        .action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #1e1e1e; padding: 12px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            display: flex; gap: 10px; border-top: 1px solid #333; z-index: 50;
        }

        .btn-action {
            border: none; border-radius: 8px; padding: 10px; flex: 1;
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 54px; cursor: pointer;
        }
        .btn-open { background: #333; border: 1px solid #555; max-width: 80px; font-size: 10px; }
        .btn-whats { background: #25D366; flex-grow: 2; opacity: 0.3; pointer-events: none; }
        .btn-save { background: #007bff; opacity: 0.3; pointer-events: none; }
        .active { opacity: 1 !important; pointer-events: auto !important; }

        input[type="file"] { display: none; }

        /* --- MODAL (Force Landscape Mobile) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #f5f5f5; z-index: 9999;
            display: none; flex-direction: column; overflow: hidden;
        }

        /* Se for celular em p√©, for√ßa a rota√ß√£o. Se for desktop, ignora. */
        .force-landscape {
            width: 100vh !important;
            height: 100vw !important;
            transform: rotate(90deg);
            transform-origin: center;
            position: fixed;
            top: 50%; left: 50%;
            margin-left: -50vh;
            margin-top: -50vw;
        }

        .modal-header { 
            padding: 10px; background: #fff; text-align: center; color: #333; font-weight: bold; 
            font-size: 14px; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center; padding-left: 20px; padding-right: 20px;
            height: 50px; flex-shrink: 0;
        }

        #padContainer { 
            flex-grow: 1; width: 100%; position: relative; overflow: hidden;
            background-color: #fff;
            background-image: radial-gradient(#ccc 1.5px, transparent 1.5px);
            background-size: 20px 20px;
        }
        
        #watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #e0e0e0; font-size: 5vh; font-weight: bold; pointer-events: none;
            text-transform: uppercase; text-align: center;
        }

        #baseline {
            position: absolute; bottom: 20%; left: 5%; width: 90%; height: 2px;
            border-bottom: 2px dashed #ddd; pointer-events: none;
        }

        #padCanvas { width: 100%; height: 100%; display: block; cursor: crosshair; }

        .modal-footer { 
            padding: 10px; background: #fff; display: flex; gap: 10px; 
            border-top: 1px solid #ddd; height: 70px; align-items: center; flex-shrink: 0;
        }
        
        .btn-m { height: 45px; flex: 1; border-radius: 8px; border: none; font-weight: bold; font-size: 14px; color: white; cursor: pointer; }
        .btn-cancel { background: #d9534f; max-width: 100px; }
        .btn-clear { background: #6c757d; max-width: 100px; }
        .btn-ok { background: #28a745; font-size: 16px; }

        #toast {
            position: fixed; bottom: 50%; left: 50%; transform: translate(-50%, 50%);
            background: rgba(0,0,0,0.8); color: white; padding: 15px 30px;
            border-radius: 8px; font-weight: bold; z-index: 200; display: none;
        }
    </style>
</head>
<body>

<header>
    <div class="title">Assinador V16</div>
    <div class="tools">
        <div id="btnUndo" class="btn-icon" onclick="undoAction()" style="opacity:0.3;">‚Ü©</div>
        <div class="btn-icon" onclick="rotateImage(-90)">‚Ü∫</div>
        <div class="btn-icon" onclick="rotateImage(90)">‚Üª</div>
    </div>
</header>

<div id="workspace">
    <div id="startScreen">
        <label for="fileInput" class="btn-big-open">
            <span>üìÇ</span>
            <h3>ABRIR ARQUIVO</h3>
            <p>PDF ou Imagem</p>
        </label>
        <div id="loading">‚åõ Processando...</div>
    </div>

    <div id="instruction">üëÜ Selecione onde quer assinar</div>
    <canvas id="mainCanvas"></canvas>
</div>

<div class="action-bar">
    <label for="fileInput" class="btn-action btn-open"><span>üìÇ</span>Abrir</label>
    <input type="file" id="fileInput" accept="*/*">
    <div id="btnWhats" class="btn-action btn-whats" onclick="shareDoc()">Enviar Whats</div>
    <div id="btnSave" class="btn-action btn-save" onclick="downloadDoc()">Baixar</div>
</div>

<div id="toast">Sucesso!</div>

<div class="modal-overlay" id="modal">
    <div class="modal-header">
        <span>‚úçÔ∏è Assinatura</span>
        <span onclick="closeModal()" style="font-size: 20px; padding: 5px; cursor: pointer;">‚úï</span>
    </div>

    <div id="padContainer">
        <div id="watermark">Assine na Tela Inteira</div>
        <div id="baseline"></div>
        <canvas id="padCanvas"></canvas>
    </div>

    <div class="modal-footer">
        <button class="btn-m btn-cancel" onclick="closeModal()">Cancelar</button>
        <button class="btn-m btn-clear" onclick="clearPad()">Limpar</button>
        <button class="btn-m btn-ok" onclick="applySignature()">‚úî CONFIRMAR</button>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    // ELEMENTOS
    const mainCanvas = document.getElementById('mainCanvas');
    const mainCtx = mainCanvas.getContext('2d');
    const padCanvas = document.getElementById('padCanvas');
    const padCtx = padCanvas.getContext('2d');
    const modal = document.getElementById('modal');
    
    // ESTADO
    let currentImage = null;
    let currentRotation = 0;
    let historyStack = [];
    let selectRect = null;
    let isSelecting = false;
    let startX, startY;
    let isForcedLandscape = false;

    // --- ABRIR ---
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        const validTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg', 'image/webp'];
        if (!validTypes.includes(file.type) && !file.name.toLowerCase().endsWith('.pdf')) {
            showToast("‚ö†Ô∏è Arquivo inv√°lido!"); return;
        }

        document.querySelector('.btn-big-open').style.display = 'none';
        document.getElementById('loading').style.display = 'block';
        mainCanvas.style.display = 'none';
        
        document.getElementById('btnWhats').classList.remove('active');
        document.getElementById('btnSave').classList.remove('active');
        historyStack = []; currentRotation = 0;

        try {
            if(file.type.includes('pdf') || file.name.endsWith('.pdf')) await handlePDF(file);
            else await handleImage(file);
        } catch(err) { alert("Erro: " + err.message); location.reload(); }
    });

    function handleImage(file) {
        return new Promise(r => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => { currentImage = img; finishLoad(); r(); };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function handlePDF(file) {
        const d = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(d).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({scale: 2.5});
        const c = document.createElement('canvas');
        c.width = viewport.width; c.height = viewport.height;
        await page.render({canvasContext:c.getContext('2d'), viewport}).promise;
        
        const img = new Image();
        img.src = c.toDataURL('image/jpeg', 0.9);
        await new Promise(r => img.onload = r);
        currentImage = img;
        finishLoad();
    }

    function finishLoad() {
        document.getElementById('startScreen').style.display = 'none';
        mainCanvas.style.display = 'block';
        document.getElementById('instruction').style.display = 'block';
        document.getElementById('btnWhats').classList.add('active');
        document.getElementById('btnSave').classList.add('active');
        renderMain();
    }

    // --- RENDER ---
    function rotateImage(deg) {
        if(!currentImage) return;
        currentRotation = (currentRotation + deg) % 360;
        renderMain();
    }

    function renderMain() {
        const isVert = Math.abs(currentRotation) === 90 || Math.abs(currentRotation) === 270;
        mainCanvas.width = isVert ? currentImage.height : currentImage.width;
        mainCanvas.height = isVert ? currentImage.width : currentImage.height;

        mainCtx.save();
        mainCtx.clearRect(0,0,mainCanvas.width, mainCanvas.height);
        mainCtx.translate(mainCanvas.width/2, mainCanvas.height/2);
        mainCtx.rotate(currentRotation * Math.PI / 180);
        mainCtx.drawImage(currentImage, -currentImage.width/2, -currentImage.height/2);
        mainCtx.restore();
    }

    // --- SELE√á√ÉO H√çBRIDA (MOUSE + TOUCH) ---
    // Helper para unificar coordenadas de mouse e touch
    function getClientPos(e) {
        if(e.touches && e.touches.length > 0) {
            return { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
        return { x: e.clientX, y: e.clientY };
    }

    function getCanvasPos(e) {
        const rect = mainCanvas.getBoundingClientRect();
        const pos = getClientPos(e);
        const sx = mainCanvas.width / rect.width;
        const sy = mainCanvas.height / rect.height;
        return { x: (pos.x - rect.left) * sx, y: (pos.y - rect.top) * sy };
    }

    // Unifica√ß√£o de listeners
    function startSel(e) {
        if(!currentImage) return;
        if(e.type === 'touchstart') e.preventDefault(); // Evita scroll no mobile
        
        isSelecting = true;
        document.getElementById('instruction').style.display='none';
        const p = getCanvasPos(e);
        startX = p.x; startY = p.y;
    }

    function moveSel(e) {
        if(!isSelecting) return;
        e.preventDefault();
        
        const p = getCanvasPos(e);
        renderMain(); // Limpa
        mainCtx.lineWidth = 4 * (mainCanvas.width/1000);
        mainCtx.strokeStyle = "#007bff";
        mainCtx.setLineDash([10]);
        mainCtx.strokeRect(startX, startY, p.x-startX, p.y-startY);
        mainCtx.fillStyle = "rgba(0,123,255,0.2)";
        mainCtx.fillRect(startX, startY, p.x-startX, p.y-startY);
        
        // Guarda ultima posi√ß√£o para o 'touchend' que n√£o tem coordenadas
        selectRect = { x: startX, y: startY, w: p.x - startX, h: p.y - startY };
    }

    function endSel(e) {
        if(!isSelecting) return;
        isSelecting = false;
        
        // Verifica se formou um retangulo v√°lido (maior que 20px)
        if(selectRect && Math.abs(selectRect.w) > 20 && Math.abs(selectRect.h) > 20) {
            openModal();
        } else {
            renderMain(); // Limpa sujeira de clique acidental
        }
    }

    // Adiciona Listeners MOUSE
    mainCanvas.addEventListener('mousedown', startSel);
    mainCanvas.addEventListener('mousemove', moveSel);
    mainCanvas.addEventListener('mouseup', endSel);

    // Adiciona Listeners TOUCH
    mainCanvas.addEventListener('touchstart', startSel, {passive:false});
    mainCanvas.addEventListener('touchmove', moveSel, {passive:false});
    mainCanvas.addEventListener('touchend', endSel);


    // --- ASSINATURA ---
    let points = [], isDrawing = false;

    function checkOrientation() {
        if(window.innerHeight > window.innerWidth) {
            modal.classList.add('force-landscape');
            isForcedLandscape = true;
        } else {
            modal.classList.remove('force-landscape');
            isForcedLandscape = false;
        }
    }

    function openModal() {
        modal.style.display = 'flex';
        checkOrientation();
        setTimeout(() => { resizePad(); clearPad(); }, 50);
        window.addEventListener('resize', handleResize);
    }

    function handleResize() { checkOrientation(); resizePad(); }

    function closeModal() {
        modal.style.display = 'none';
        modal.classList.remove('force-landscape');
        window.removeEventListener('resize', handleResize);
        renderMain();
    }

    function resizePad() {
        const container = document.getElementById('padContainer');
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        padCanvas.width = container.offsetWidth * ratio;
        padCanvas.height = container.offsetHeight * ratio;
        padCtx.scale(ratio, ratio);
        padCtx.lineWidth = 3; padCtx.lineJoin = 'round'; padCtx.lineCap = 'round'; padCtx.strokeStyle = '#000080';
    }

    function clearPad() { 
        padCtx.clearRect(0,0,padCanvas.width,padCanvas.height); 
        points=[]; document.getElementById('watermark').style.display = 'block'; 
    }

    // Coordenadas Corretas (H√≠brido Mouse/Touch + Force Landscape)
    function getCorrectPos(e) {
        const pos = getClientPos(e); // Pega X/Y brutos da tela (Mouse ou Touch)
        
        if(!isForcedLandscape) {
             const r = padCanvas.getBoundingClientRect();
             return { x: pos.x - r.left, y: pos.y - r.top };
        } else {
             // L√≥gica Force Landscape (Gira coordenadas 90 graus)
             return {
                 x: pos.y, 
                 y: window.innerWidth - pos.x
             };
        }
    }

    function startDraw(e) {
        if(e.type === 'touchstart') e.preventDefault();
        isDrawing=true; 
        points.push(getCorrectPos(e));
        document.getElementById('watermark').style.display = 'none';
    }

    function moveDraw(e) {
        if(!isDrawing) return;
        e.preventDefault();
        points.push(getCorrectPos(e));
        if(points.length < 3) return;
        padCtx.beginPath();
        padCtx.moveTo(points[points.length-2].x, points[points.length-2].y);
        padCtx.lineTo(points[points.length-1].x, points[points.length-1].y);
        padCtx.stroke();
    }

    function endDraw() { isDrawing=false; points=[]; }

    // Listeners Pad MOUSE
    padCanvas.addEventListener('mousedown', startDraw);
    padCanvas.addEventListener('mousemove', moveDraw);
    padCanvas.addEventListener('mouseup', endDraw);

    // Listeners Pad TOUCH
    padCanvas.addEventListener('touchstart', startDraw, {passive:false});
    padCanvas.addEventListener('touchmove', moveDraw, {passive:false});
    padCanvas.addEventListener('touchend', endDraw);

    // --- FINALIZAR ---
    function applySignature() {
        if(currentImage) { historyStack.push(currentImage.src); document.getElementById('btnUndo').style.opacity=1; document.getElementById('btnUndo').style.pointerEvents='auto'; }
        closeModal();
        renderMain();
        mainCtx.drawImage(padCanvas, selectRect.x, selectRect.y, selectRect.w, selectRect.h);
        const i = new Image();
        i.src = mainCanvas.toDataURL('image/png', 1.0);
        i.onload = () => { currentImage = i; renderMain(); showToast("Assinado!"); }
    }

    function undoAction() {
        if(!historyStack.length) return;
        const src = historyStack.pop();
        if(!historyStack.length) { document.getElementById('btnUndo').style.opacity=0.3; document.getElementById('btnUndo').style.pointerEvents='none'; }
        const i = new Image(); i.src = src; i.onload = () => { currentImage=i; renderMain(); showToast("Desfeito"); }
    }

    function showToast(msg) {
        const t = document.getElementById('toast'); t.innerText=msg; t.style.display='block';
        setTimeout(()=>t.style.display='none', 2000);
    }

    async function shareDoc() {
        if(!currentImage) return;
        mainCanvas.toBlob(async (b) => {
            const f = new File([b], "Assinado.png", {type: "image/png"});
            try { await navigator.share({files:[f]}); } catch(e){}
        });
    }

    function downloadDoc() {
        if(!currentImage) return;
        const a = document.createElement('a'); a.download = `Doc_${Date.now()}.png`;
        a.href = mainCanvas.toDataURL(); a.click();
    }
</script>
</body>
</html>
