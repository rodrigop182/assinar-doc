<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Assinador V17 - Stable</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        /* --- CSS --- */
        :root { --app-bg: #121212; --panel-bg: #1e1e1e; --primary: #007bff; }
        
        * { box-sizing: border-box; touch-action: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; background-color: var(--app-bg); color: #eee;
            display: flex; flex-direction: column; 
            height: 100dvh; /* Altura din√¢mica real */
            overflow: hidden; /* Trava scroll do corpo */
        }

        /* HEADER */
        header {
            background: var(--panel-bg); padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px; border-bottom: 1px solid #333; z-index: 20; flex-shrink: 0;
        }

        .title { font-weight: 700; font-size: 16px; color: #fff; }
        .tools { display: flex; gap: 12px; }
        .btn-icon {
            background: #2c2c2c; border: 1px solid #444; color: #eee;
            width: 40px; height: 40px; border-radius: 8px;
            font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .btn-icon:hover { background: #444; }

        /* WORKSPACE */
        #workspace {
            flex-grow: 1; position: relative; background: #000;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            padding-bottom: 80px; /* Espa√ßo pro menu */
            cursor: crosshair;
        }

        #mainCanvas {
            max-width: 98%; max-height: 98%;
            box-shadow: 0 0 20px rgba(0,0,0,0.8); display: none; 
        }

        /* START SCREEN */
        #startScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: var(--app-bg); z-index: 5;
        }
        
        .btn-big-open {
            background: #2a2a2a; border: 2px dashed #555; color: #ddd;
            width: 85%; padding: 40px 20px; border-radius: 16px;
            text-align: center; margin-top: -60px; transition: background 0.2s; cursor: pointer;
        }
        .btn-big-open span { font-size: 45px; display: block; margin-bottom: 15px; }
        .btn-big-open h3 { margin: 0; font-size: 20px; color: #fff; font-weight: 600; }
        
        #instruction {
            position: absolute; top: 15px;
            background: rgba(255, 193, 7, 0.95); color: #000;
            padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 13px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); pointer-events: none;
            display: none; z-index: 10;
        }
        
        #loading { display: none; color: #aaa; font-size: 14px; margin-top: 20px; }

        /* ACTION BAR FIXA */
        .action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--panel-bg); padding: 10px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            display: flex; gap: 10px; border-top: 1px solid #333; z-index: 50;
            height: auto;
        }

        .btn-action {
            border: none; border-radius: 8px; padding: 0; flex: 1;
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            color: white; display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 50px; cursor: pointer;
        }
        .btn-open { background: #333; border: 1px solid #555; max-width: 80px; font-size: 10px; }
        .btn-whats { background: #25D366; flex-grow: 2; opacity: 0.3; pointer-events: none; }
        .btn-save { background: #007bff; opacity: 0.3; pointer-events: none; }
        .active { opacity: 1 !important; pointer-events: auto !important; }

        input[type="file"] { display: none; }

        /* --- MODAL (ENGINE V17) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; 
            width: 100vw; height: 100dvh;
            background: #fff; z-index: 9999;
            display: none; 
            overflow: hidden; /* Impede scroll interno */
        }

        /* Estrutura Flex Interna do Modal (Para bot√µes n√£o sumirem) */
        .modal-content {
            display: flex; flex-direction: column;
            width: 100%; height: 100%;
        }

        /* CLASSE DE ROTA√á√ÉO FOR√áADA (Quando em Portrait) */
        .force-landscape {
            width: 100dvh !important; /* Altura vira largura */
            height: 100vw !important; /* Largura vira altura */
            transform: rotate(90deg);
            transform-origin: center;
            position: fixed;
            top: 50%; left: 50%;
            margin-left: -50dvh; /* Centraliza */
            margin-top: -50vw;
        }

        .modal-header { 
            padding: 10px 20px; background: #eee; color: #333; font-weight: bold; 
            font-size: 14px; border-bottom: 1px solid #ddd;
            display: flex; justify-content: space-between; align-items: center;
            height: 50px; flex-shrink: 0;
            padding-left: max(20px, env(safe-area-inset-left)); /* Prote√ß√£o Notch na rota√ß√£o */
        }

        #padContainer { 
            flex-grow: 1; /* Ocupa todo espa√ßo restante */
            width: 100%; position: relative; overflow: hidden;
            background-color: #fff;
            background-image: radial-gradient(#ccc 1.5px, transparent 1.5px);
            background-size: 20px 20px;
            cursor: crosshair;
        }
        
        #padCanvas { width: 100%; height: 100%; display: block; touch-action: none; }

        .modal-footer { 
            padding: 10px; background: #eee; display: flex; gap: 10px; 
            border-top: 1px solid #ddd; 
            height: 70px; align-items: center; flex-shrink: 0;
            padding-right: max(10px, env(safe-area-inset-right)); /* Prote√ß√£o Notch na rota√ß√£o */
        }
        
        .btn-m { height: 100%; flex: 1; border-radius: 8px; border: none; font-weight: bold; font-size: 14px; color: white; cursor: pointer; }
        .btn-cancel { background: #d9534f; max-width: 100px; }
        .btn-clear { background: #6c757d; max-width: 100px; }
        .btn-ok { background: #28a745; font-size: 16px; }

        #watermark {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ddd; font-size: 5vh; font-weight: bold; pointer-events: none;
            text-transform: uppercase; text-align: center; user-select: none;
        }

        #toast {
            position: fixed; bottom: 50%; left: 50%; transform: translate(-50%, 50%);
            background: rgba(0,0,0,0.8); color: white; padding: 15px 30px;
            border-radius: 8px; font-weight: bold; z-index: 200; display: none;
        }
    </style>
</head>
<body>

<header>
    <div class="title">Assinador V17</div>
    <div class="tools">
        <div id="btnUndo" class="btn-icon" onclick="undoAction()" style="opacity:0.3;">‚Ü©</div>
        <div class="btn-icon" onclick="rotateImage(-90)">‚Ü∫</div>
        <div class="btn-icon" onclick="rotateImage(90)">‚Üª</div>
    </div>
</header>

<div id="workspace">
    <div id="startScreen">
        <label for="fileInput" class="btn-big-open">
            <span>üìÇ</span>
            <h3>ABRIR ARQUIVO</h3>
            <p>PDF ou Imagem</p>
        </label>
        <div id="loading">‚åõ Carregando...</div>
    </div>

    <div id="instruction">üëÜ Selecione onde quer assinar</div>
    <canvas id="mainCanvas"></canvas>
</div>

<div class="action-bar">
    <label for="fileInput" class="btn-action btn-open"><span>üìÇ</span>Abrir</label>
    <input type="file" id="fileInput" accept="*/*">
    <div id="btnWhats" class="btn-action btn-whats" onclick="shareDoc()">Enviar Whats</div>
    <div id="btnSave" class="btn-action btn-save" onclick="downloadDoc()">Baixar</div>
</div>

<div id="toast">Sucesso!</div>

<div class="modal-overlay" id="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>‚úçÔ∏è Tela Cheia</span>
            <span onclick="closeModal()" style="font-size: 24px; padding: 0 10px; cursor: pointer;">‚úï</span>
        </div>

        <div id="padContainer">
            <div id="watermark">Assine Aqui</div>
            <canvas id="padCanvas"></canvas>
        </div>

        <div class="modal-footer">
            <button class="btn-m btn-cancel" onclick="closeModal()">Cancelar</button>
            <button class="btn-m btn-clear" onclick="clearPad()">Limpar</button>
            <button class="btn-m btn-ok" onclick="applySignature()">‚úî CONFIRMAR</button>
        </div>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    // ELEMENTOS
    const mainCanvas = document.getElementById('mainCanvas');
    const mainCtx = mainCanvas.getContext('2d');
    const padCanvas = document.getElementById('padCanvas');
    const padCtx = padCanvas.getContext('2d');
    const modal = document.getElementById('modal');
    const modalContent = document.querySelector('.modal-content');
    
    // ESTADO
    let currentImage = null;
    let currentRotation = 0;
    let historyStack = [];
    let selectRect = null;
    let isSelecting = false;
    let startX, startY;
    
    // ESTADO DA ASSINATURA
    let isForcedLandscape = false;
    let tempSignatureData = null; // Para salvar o desenho ao girar

    // --- ABRIR ARQUIVO ---
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;

        const validTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg', 'image/webp'];
        if (!validTypes.includes(file.type) && !file.name.toLowerCase().endsWith('.pdf')) {
            showToast("‚ö†Ô∏è Arquivo inv√°lido!"); return;
        }

        document.querySelector('.btn-big-open').style.display = 'none';
        document.getElementById('loading').style.display = 'block';
        mainCanvas.style.display = 'none';
        document.getElementById('btnWhats').classList.remove('active');
        document.getElementById('btnSave').classList.remove('active');
        historyStack = []; currentRotation = 0;

        try {
            if(file.type.includes('pdf') || file.name.endsWith('.pdf')) await handlePDF(file);
            else await handleImage(file);
        } catch(err) { alert("Erro: " + err.message); location.reload(); }
    });

    function handleImage(file) {
        return new Promise(r => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => { currentImage = img; finishLoad(); r(); };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function handlePDF(file) {
        const d = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(d).promise;
        const page = await pdf.getPage(1);
        const viewport = page.getViewport({scale: 3.0}); // Qualidade Alta
        const c = document.createElement('canvas');
        c.width = viewport.width; c.height = viewport.height;
        await page.render({canvasContext:c.getContext('2d'), viewport}).promise;
        
        const img = new Image();
        img.src = c.toDataURL('image/jpeg', 0.9);
        await new Promise(r => img.onload = r);
        currentImage = img;
        finishLoad();
    }

    function finishLoad() {
        document.getElementById('startScreen').style.display = 'none';
        mainCanvas.style.display = 'block';
        document.getElementById('instruction').style.display = 'block';
        document.getElementById('btnWhats').classList.add('active');
        document.getElementById('btnSave').classList.add('active');
        renderMain();
    }

    // --- RENDER MAIN ---
    function rotateImage(deg) {
        if(!currentImage) return;
        currentRotation = (currentRotation + deg) % 360;
        renderMain();
    }

    function renderMain() {
        const isVert = Math.abs(currentRotation) === 90 || Math.abs(currentRotation) === 270;
        mainCanvas.width = isVert ? currentImage.height : currentImage.width;
        mainCanvas.height = isVert ? currentImage.width : currentImage.height;

        mainCtx.save();
        mainCtx.clearRect(0,0,mainCanvas.width, mainCanvas.height);
        mainCtx.translate(mainCanvas.width/2, mainCanvas.height/2);
        mainCtx.rotate(currentRotation * Math.PI / 180);
        mainCtx.drawImage(currentImage, -currentImage.width/2, -currentImage.height/2);
        mainCtx.restore();
    }

    // --- SELE√á√ÉO ---
    function getClientPos(e) {
        if(e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
        return { x: e.clientX, y: e.clientY };
    }

    function getCanvasPos(e) {
        const rect = mainCanvas.getBoundingClientRect();
        const pos = getClientPos(e);
        const sx = mainCanvas.width / rect.width;
        const sy = mainCanvas.height / rect.height;
        return { x: (pos.x - rect.left) * sx, y: (pos.y - rect.top) * sy };
    }

    function startSel(e) {
        if(!currentImage) return;
        if(e.type === 'touchstart') e.preventDefault();
        isSelecting = true; document.getElementById('instruction').style.display='none';
        const p = getCanvasPos(e); startX = p.x; startY = p.y;
    }

    function moveSel(e) {
        if(!isSelecting) return;
        e.preventDefault();
        const p = getCanvasPos(e);
        renderMain();
        mainCtx.lineWidth = 4 * (mainCanvas.width/1000);
        mainCtx.strokeStyle = "#007bff"; mainCtx.setLineDash([10]);
        mainCtx.strokeRect(startX, startY, p.x-startX, p.y-startY);
        mainCtx.fillStyle = "rgba(0,123,255,0.2)";
        mainCtx.fillRect(startX, startY, p.x-startX, p.y-startY);
        selectRect = { x: startX, y: startY, w: p.x - startX, h: p.y - startY };
    }

    function endSel(e) {
        if(!isSelecting) return;
        isSelecting = false;
        if(selectRect && Math.abs(selectRect.w) > 20 && Math.abs(selectRect.h) > 20) {
            openModal();
        } else { renderMain(); }
    }

    mainCanvas.addEventListener('mousedown', startSel);
    mainCanvas.addEventListener('mousemove', moveSel);
    mainCanvas.addEventListener('mouseup', endSel);
    mainCanvas.addEventListener('touchstart', startSel, {passive:false});
    mainCanvas.addEventListener('touchmove', moveSel, {passive:false});
    mainCanvas.addEventListener('touchend', endSel);

    // --- ASSINATURA & ROTA√á√ÉO INTELIGENTE ---
    
    function checkOrientation() {
        // Se a altura da janela for maior que largura = Portrait = FOR√áA ROTA√á√ÉO
        if(window.innerHeight > window.innerWidth) {
            modalContent.classList.add('force-landscape');
            isForcedLandscape = true;
        } else {
            // Se virou o celular e agora √© Landscape = REMOVE ROTA√á√ÉO
            modalContent.classList.remove('force-landscape');
            isForcedLandscape = false;
        }
    }

    function openModal() {
        modal.style.display = 'flex';
        checkOrientation();
        // Delay para garantir que o DOM atualizou antes de redimensionar o canvas
        setTimeout(() => {
            resizePad(true); // true = clean start
        }, 50);
        window.addEventListener('resize', handleResize);
    }

    function handleResize() {
        // 1. Salva o desenho atual
        saveTempSignature();
        // 2. Verifica nova orienta√ß√£o
        checkOrientation();
        // 3. Redimensiona o canvas
        resizePad(false); // false = n√£o apagar
        // 4. Restaura o desenho (esticando se necess√°rio, ou melhor, redesenhando)
        restoreTempSignature();
    }

    function closeModal() {
        modal.style.display = 'none';
        window.removeEventListener('resize', handleResize);
        renderMain();
    }

    function saveTempSignature() {
        // Salva apenas se tiver dimens√µes v√°lidas
        if(padCanvas.width > 0 && padCanvas.height > 0) {
            tempSignatureData = padCanvas.toDataURL();
        }
    }

    function restoreTempSignature() {
        if(tempSignatureData) {
            const img = new Image();
            img.src = tempSignatureData;
            img.onload = () => {
                padCtx.drawImage(img, 0, 0, padCanvas.width, padCanvas.height);
            };
        }
    }

    function resizePad(clean) {
        const container = document.getElementById('padContainer');
        // Ratio 2 para telas retina (qualidade HD)
        const ratio = Math.max(window.devicePixelRatio || 1, 2); 
        
        padCanvas.width = container.offsetWidth * ratio;
        padCanvas.height = container.offsetHeight * ratio;
        padCtx.scale(ratio, ratio);
        
        // Configura Caneta
        padCtx.lineWidth = 4; // Mais grosso para ver bem
        padCtx.lineJoin = 'round';
        padCtx.lineCap = 'round';
        padCtx.strokeStyle = '#000000'; // Preto s√≥lido
        padCtx.shadowBlur = 0.5; // Suaviza bordas
        padCtx.shadowColor = '#000000';

        if(clean) clearPad();
    }

    function clearPad() { 
        padCtx.clearRect(0,0,padCanvas.width,padCanvas.height); 
        points=[]; tempSignatureData=null;
        document.getElementById('watermark').style.display = 'block'; 
    }

    // --- INPUT DA ASSINATURA (CORRE√á√ÉO DE COORDENADAS) ---
    let points = [], isDrawing = false;

    function getCorrectPos(e) {
        const pos = getClientPos(e);
        
        if(!isForcedLandscape) {
             // Modo Normal (Desktop ou Celular Deitado Nativo)
             const r = padCanvas.getBoundingClientRect();
             return { x: pos.x - r.left, y: pos.y - r.top };
        } else {
             // Modo For√ßado (Celular em P√© -> Tela Girada 90¬∫)
             // O "X" da tela vira o "Y" do canvas (invertido pela rota√ß√£o?)
             // A tela gira em torno do centro.
             
             // Mapeamento Correto V17:
             // Toque X (da esquerda pra direita no celular em p√©) = Canvas Y (de cima pra baixo na assinatura)
             // Toque Y (de cima pra baixo no celular em p√©) = Canvas X (da direita pra esquerda?? N√£o, o topo √© a esquerda)
             
             // Vamos simplificar usando a posi√ß√£o relativa ao viewport, j√° que o elemento ocupa 100vh/100vw
             const xRaw = pos.x;
             const yRaw = pos.y;
             
             // Largura e Altura VISUAIS do Canvas (que est√£o trocadas no CSS)
             // No modo for√ßado: WidthCSS = 100vh (altura da tela), HeightCSS = 100vw (largura da tela)
             
             // Formula definitiva para rota√ß√£o 90deg CW:
             // CanvasX = Y_Tela
             // CanvasY = Largura_Tela - X_Tela
             
             return {
                 x: yRaw,
                 y: window.innerWidth - xRaw
             };
        }
    }

    // Curvas Suaves (Quadratic B√©zier)
    function startDraw(e) {
        if(e.type === 'touchstart') e.preventDefault();
        isDrawing=true; 
        const p = getCorrectPos(e);
        points.push(p);
        document.getElementById('watermark').style.display = 'none';
        
        padCtx.beginPath();
        padCtx.moveTo(p.x, p.y);
        padCtx.lineTo(p.x, p.y); // Ponto inicial
        padCtx.stroke();
    }

    function moveDraw(e) {
        if(!isDrawing) return;
        e.preventDefault();
        const p = getCorrectPos(e);
        points.push(p);

        if(points.length < 3) return;
        
        const last = points[points.length-1];
        const prev = points[points.length-2];
        const prev2 = points[points.length-3]; // Control point

        // Desenha curva suave entre os pontos
        // Usa o ponto m√©dio como controle para suavizar
        const cpX = (prev.x + last.x) / 2;
        const cpY = (prev.y + last.y) / 2;

        padCtx.beginPath();
        padCtx.moveTo(prev.x, prev.y);
        padCtx.quadraticCurveTo(cpX, cpY, last.x, last.y);
        // Fallback simples para garantir que risca:
        // padCtx.lineTo(p.x, p.y);
        padCtx.stroke();
    }

    function endDraw() { isDrawing=false; points=[]; tempSignatureData = padCanvas.toDataURL(); }

    padCanvas.addEventListener('mousedown', startDraw);
    padCanvas.addEventListener('mousemove', moveDraw);
    padCanvas.addEventListener('mouseup', endDraw);
    padCanvas.addEventListener('touchstart', startDraw, {passive:false});
    padCanvas.addEventListener('touchmove', moveDraw, {passive:false});
    padCanvas.addEventListener('touchend', endDraw);

    // --- FINALIZAR ---
    function applySignature() {
        if(currentImage) { historyStack.push(currentImage.src); document.getElementById('btnUndo').style.opacity=1; document.getElementById('btnUndo').style.pointerEvents='auto'; }
        closeModal();
        renderMain();
        mainCtx.drawImage(padCanvas, selectRect.x, selectRect.y, selectRect.w, selectRect.h);
        const i = new Image();
        i.src = mainCanvas.toDataURL('image/png', 1.0);
        i.onload = () => { currentImage = i; renderMain(); showToast("Assinado!"); }
    }

    function undoAction() {
        if(!historyStack.length) return;
        const src = historyStack.pop();
        if(!historyStack.length) { document.getElementById('btnUndo').style.opacity=0.3; document.getElementById('btnUndo').style.pointerEvents='none'; }
        const i = new Image(); i.src = src; i.onload = () => { currentImage=i; renderMain(); showToast("Desfeito"); }
    }

    function showToast(msg) {
        const t = document.getElementById('toast'); t.innerText=msg; t.style.display='block';
        setTimeout(()=>t.style.display='none', 2000);
    }

    async function shareDoc() {
        if(!currentImage) return;
        mainCanvas.toBlob(async (b) => {
            const f = new File([b], "Assinado.png", {type: "image/png"});
            try { await navigator.share({files:[f]}); } catch(e){}
        });
    }

    function downloadDoc() {
        if(!currentImage) return;
        const a = document.createElement('a'); a.download = `Doc_${Date.now()}.png`;
        a.href = mainCanvas.toDataURL(); a.click();
    }
</script>
</body>
</html>
